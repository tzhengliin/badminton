<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>維多利亞羽球學院 - 場地費計算器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        background: #f8f9fa;
      }
      .table thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
      }
      .slot-badge {
        font-variant-numeric: tabular-nums;
      }
      .price-input,
      .people-input {
        max-width: 140px;
      }
      .per-person {
        min-width: 96px;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h4 m-0">維多利亞羽球學院</h1>
        <h1 class="h4 m-0">羽球場地費計算器</h1>
        <div class="d-flex gap-2">
          <button id="resetPricesBtn" class="btn btn-outline-secondary btn-sm">恢復預設價格</button>
          <button id="clearPeopleBtn" class="btn btn-outline-secondary btn-sm">清空人數</button>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle m-0">
              <thead class="table-light">
                <tr>
                  <th class="text-nowrap">時段</th>
                  <th class="text-nowrap">價格（元）</th>
                  <th class="text-nowrap">人數</th>
                  <th class="text-end text-nowrap">費用（該時段）</th>
                </tr>
              </thead>
              <tbody id="slotTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <datalist id="priceSuggestions">
        <option value="270"></option>
        <option value="300"></option>
        <option value="350"></option>
        <option value="400"></option>
        <option value="450"></option>
        <option value="500"></option>
      </datalist>

      <div class="small text-muted mt-3">說明：每列「每小時價格」會依時段長度自動換算（此頁皆為 30 分鐘時段，故採 0.5 倍）。 人數空白或為 0 則不計算。</div>
      <div class="fs-2 text-muted mt-3">除場地費外，額外收球錢20元，請自行加總。</div>
    </div>

    <script>
      function pad(n) {
        return n.toString().padStart(2, "0");
      }
      function labelOf(h, m) {
        const start = `${pad(h)}:${pad(m)}`;
        let eh = h,
          em = m + 30;
        if (em >= 60) {
          eh += 1;
          em -= 60;
        }
        const end = eh === 24 ? "24:00" : `${pad(eh)}:${pad(em)}`;
        return `${start}–${end}`;
      }

      function defaultPerHour(h) {
        return h < 23 ? 450 : 270;
      }

      const tbody = document.getElementById("slotTbody");
      for (let h = 19; h < 24; h++) {
        for (let m = 0; m < 60; m += 30) {
          const tr = document.createElement("tr");
          tr.className = "timeslot";
          tr.dataset.minutes = 30;
          tr.dataset.defaultPerHour = defaultPerHour(h);

          tr.innerHTML = `
          <td><span class="badge text-bg-secondary slot-badge">${labelOf(h, m)}</span></td>
          <td>
            <input type="number" class="form-control form-control-sm price-input"
                   min="0" step="10" value="${defaultPerHour(h)}" aria-label="每小時價格"
                   list="priceSuggestions">
          </td>
          <td>
            <input type="number" class="form-control form-control-sm people-input"
                   min="0" step="1" placeholder="人數" aria-label="人數">
          </td>
          <td class="per-person text-end fw-medium">—</td>
        `;
          tbody.appendChild(tr);
        }
      }

      function formatCurrency(n) {
        if (isNaN(n)) return "—";
        return "NT$ " + Math.round(n).toLocaleString("zh-Hant-TW");
      }

      function recalcRow(tr) {
        const minutes = Number(tr.dataset.minutes || 30);
        const defaultPerHour = Number(tr.dataset.defaultPerHour || 0);
        const priceInput = tr.querySelector(".price-input");
        const peopleInput = tr.querySelector(".people-input");
        const perPersonCell = tr.querySelector(".per-person");

        let perHour = Number(priceInput.value);
        const people = Number(peopleInput.value);

        if (!priceInput.value || isNaN(perHour)) perHour = defaultPerHour;
        if (!people || isNaN(people) || people <= 0) {
          perPersonCell.textContent = "—";
          perPersonCell.title = "";
          return;
        }
        const slotCost = perHour * (minutes / 60);
        const perPerson = slotCost / people;

        perPersonCell.textContent = formatCurrency(perPerson);
        perPersonCell.title = `公式：${perHour} × ${minutes / 60} ÷ ${people}`;
      }

      function recalcAll() {
        document.querySelectorAll("tr.timeslot").forEach(recalcRow);
      }

      // document.querySelectorAll("tr.timeslot").forEach((tr) => {
      //   tr.querySelector(".price-input").addEventListener("input", () => recalcRow(tr));
      //   tr.querySelector(".people-input").addEventListener("input", () => recalcRow(tr));
      // });
      document.querySelectorAll("tr.timeslot").forEach((tr) => {
        tr.querySelector(".price-input").addEventListener("input", () => recalcRow(tr));

        tr.querySelector(".people-input").addEventListener("change", () => {
          // ← 新增 change 事件
          recalcRow(tr);
          bridgeFillPeople(); // ← 關鍵：嘗試橋接填值
        });

        // 若你想在即時輸入就補值，也可加上 input 事件（選用）
        // tr.querySelector(".people-input")
        //   .addEventListener("input", () => { recalcRow(tr); bridgeFillPeople(); });
      });

      document.getElementById("resetPricesBtn").addEventListener("click", () => {
        document.querySelectorAll("tr.timeslot").forEach((tr) => {
          tr.querySelector(".price-input").value = tr.dataset.defaultPerHour;
        });
        recalcAll();
      });

      document.getElementById("clearPeopleBtn").addEventListener("click", () => {
        document.querySelectorAll(".people-input").forEach((inp) => (inp.value = ""));
        recalcAll();
      });

      recalcAll();

      // 判斷人數欄是否視為「空」
      function isEmptyPeopleInput(input) {
        const v = Number(input.value);
        return input.value === "" || isNaN(v) || v <= 0;
      }

      // 橋接填值：若左右端點人數一致，且中間空白→幫忙補上
      function bridgeFillPeople() {
        const rows = Array.from(document.querySelectorAll("tr.timeslot"));
        const peopleInputs = rows.map((r) => r.querySelector(".people-input"));
        const n = peopleInputs.length;

        let i = 0;
        while (i < n) {
          // 找左端點（第一個非空）
          while (i < n && isEmptyPeopleInput(peopleInputs[i])) i++;
          if (i >= n - 1) break;

          // 往右找下一個非空作為右端點
          let j = i + 1;
          while (j < n && isEmptyPeopleInput(peopleInputs[j])) j++;
          if (j >= n) break;

          const leftVal = Number(peopleInputs[i].value);
          const rightVal = Number(peopleInputs[j].value);

          // 左右端點相等 → 填滿中間空白
          if (leftVal > 0 && leftVal === rightVal) {
            for (let k = i + 1; k < j; k++) {
              if (isEmptyPeopleInput(peopleInputs[k])) {
                peopleInputs[k].value = leftVal;
                // 只重算被填到的那幾列，效能更好
                const tr = rows[k];
                if (typeof recalcRow === "function") recalcRow(tr);
              }
            }
          }

          // 往後續端點繼續掃描
          i = j;
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
